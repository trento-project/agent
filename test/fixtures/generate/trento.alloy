// =============================================================================
// Trento System Metrics Configuration
// Generated by: trento-agent generate alloy
// Agent ID: 779cdd70-e9e2-58ca-b18a-bf3eb3f71244
//
// This file is managed by Trento. Manual changes may be overwritten.
// =============================================================================

// Collect system metrics (CPU, memory, etc.) using the built-in unix exporter
prometheus.exporter.unix "trento_system" {
    set_collectors = [
        "cpu",
        "cpufreq",
        "loadavg",
        "meminfo",
        "filesystem",
        "netdev",
        "uname",
    ]
}

// Relabel metrics for Trento identification
discovery.relabel "trento_system" {
    targets = prometheus.exporter.unix.trento_system.targets

    rule {
        target_label = "agentID"
        replacement  = "779cdd70-e9e2-58ca-b18a-bf3eb3f71244"
    }

    rule {
        target_label = "exporter_name"
        replacement  = "grafana_alloy"
    }

}

// Scrape the system metrics
prometheus.scrape "trento_system" {
    targets         = discovery.relabel.trento_system.output
    forward_to      = [prometheus.remote_write.trento.receiver]
    scrape_interval = "15s"
}

// Push metrics to Trento server's Prometheus endpoint
prometheus.remote_write "trento" {
    endpoint {
        url = "https://trento.example.com/api/v1/write"

        bearer_token = "trento-api-token"

        tls_config {
            insecure_skip_verify = false
            ca_file = "/etc/trento/certs/ca.crt"
        }
    }
}
