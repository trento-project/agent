// =============================================================================
// Trento System Metrics Configuration
// Generated by: trento-agent generate alloy
// Agent ID: {{ .AgentID }}
//
// This file is managed by Trento. Manual changes may be overwritten.
// =============================================================================

// Collect system metrics (CPU, memory, etc.) using the built-in unix exporter
prometheus.exporter.unix "trento_system" {
    set_collectors = [
        "cpu",
        "cpufreq",
        "loadavg",
        "meminfo",
        "filesystem",
        "netdev",
        "uname",
    ]
}

// Relabel metrics for Trento identification
discovery.relabel "trento_system" {
    targets = prometheus.exporter.unix.trento_system.targets

    rule {
        target_label = "agentID"
        replacement  = "{{ .AgentID }}"
    }

    rule {
        target_label = "exporter_name"
        replacement  = "{{ .ExporterName }}"
    }

}

// Scrape the system metrics
prometheus.scrape "trento_system" {
    targets         = discovery.relabel.trento_system.output
    forward_to      = [prometheus.remote_write.trento.receiver]
    scrape_interval = "{{ .ScrapeInterval }}"
}

// Push metrics to Trento server's Prometheus endpoint
prometheus.remote_write "trento" {
    endpoint {
        url = "{{ .PrometheusURL }}"
{{- if eq .AuthMethod "basic" }}

        basic_auth {
            username = "{{ .AuthUsername }}"
            password = "{{ .AuthPassword }}"
        }
{{- else if eq .AuthMethod "bearer" }}

        bearer_token = "{{ .AuthBearerToken }}"
{{- end }}

        tls_config {
            insecure_skip_verify = false
{{- if .TLSCACert }}
            ca_file = "{{ .TLSCACert }}"
{{- end }}
{{- if eq .AuthMethod "mtls" }}
            cert_file = "{{ .TLSClientCert }}"
            key_file  = "{{ .TLSClientKey }}"
{{- end }}
        }
    }
}
